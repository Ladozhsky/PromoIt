@page "/add-donation/{id:int}"
@attribute [Authorize]
@using System.Net.Http;
@using System.Net.Http.Json;
@using PromoItBlazorServer.Data;
@using System.Net.Http.Headers;
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IHttpContextAccessor HttpContextAccessor

<head>
    <title>Donation</title>
    <link href="~/css/mycss.css" rel="stylesheet" />
</head>

<h1>Make your donation</h1>

<img src="https://cdnn21.img.ria.ru/images/96378/63/963786378_0:105:2000:1230_600x0_80_0_0_bd991d21f2e979514ae76e42410fd11c.jpg.webp" width="700px"/>
<br />
<div class="card text-center donation-card">

<h3>Campaign: @campaign.CampaignName</h3>

<form method="post" @onsubmit="@SubmitForm">
    <div>
    <label for="product">Choose product you want to donate</label>
    <select id="product" class="form-select form-select-lg mb-3" @bind="@order.ProductId">
    @foreach (var product in products)
            {
                <option value="@product.ProductId">@product.ProductName</option>
            }
    </select>
    </div>
    <div class="form-group">
        <label for="amount">Amount</label>
        <input type="text" class="form-control" id="amount" @bind="@order.Amount" required />
    </div>

    <button type="submit" class="btn btn-primary">Donate</button>
</form>
</div>
@if (ErrorMessage != null)
{
                <div class="alert alert-danger">@ErrorMessage</div>
}

@code {
    private string ErrorMessage { get; set; }

    [Parameter]
    public int? id { get; set; }

    HttpClient http = new HttpClient();

    private CampaignDto campaign = new CampaignDto();
    private List<ProductDto> products = new List<ProductDto>();
    public OrderDto order = new OrderDto();

    protected override async Task OnInitializedAsync()
    {
        string token = HttpContextAccessor.HttpContext.Request.Cookies["auth_token"];

        http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        campaign = await http.GetFromJsonAsync<CampaignDto>($"https://localhost:7096/api/Campaigns/{id}");

        products = await http.GetFromJsonAsync<List<ProductDto>>("https://localhost:7096/api/Products/byCompany");

    }

    private async Task SubmitForm()
    {
        try
        {
            string token = HttpContextAccessor.HttpContext.Request.Cookies["auth_token"];

            http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            order.CampaignId = campaign.CampaignId;

            HttpResponseMessage response = await http.PostAsJsonAsync("https://localhost:7096/api/Orders", order);
            if (response.IsSuccessStatusCode)
            {
                response.EnsureSuccessStatusCode();

                NavigationManager.NavigateTo("/campaigns");
            }
            else
            {
                object error = await response.Content.ReadAsStringAsync();
                Console.WriteLine(error);
                await JSRuntime.InvokeAsync<object>("alert", error);
            }
        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = ex.Message;
        }
    }
}

